import Head from "next/head";
import { useEffect, useState } from "react";
import smsJson from "./sms.json";

export default function Home() {
	const [bankSms, setBankSms] = useState([]);
	const [documentList, setDocumentList] = useState([]);
	const [nlpDocument, setnlpDocument] = useState({});
	const [bankSmsCount, setBankSmsCount] = useState(0);
	const [startOffset, setStartOffset] = useState(0);
	const [endOffset, setEndOffset] = useState(0);
	const [cursor, setCursor] = useState(0);
	const numberOfFeatures = 6;
	var featureList = ["amount", "transactionType", "accountNumber", "date", "payer", "balance"];

	const addEventListeners = () => {
		document.body.onkeyup = function (e) {
			setnlpDocument(
				getUpdatedDocument(startOffset, endOffset, bankSms[bankSmsCount], featureList[cursor], nlpDocument)
			);
			setCursor((cursor + 1) % numberOfFeatures);
			if ((cursor + 1) % numberOfFeatures === 0) {
				setBankSmsCount(bankSmsCount + 1);
				setDocumentList(documentList.concat(nlpDocument));
				setnlpDocument({});
				updateLocalStorage();
			}
			clearSelection();
		};
	};

	// clear text selection
	const clearSelection = () => {
		if (window.getSelection) {
			if (window.getSelection().empty) {
				window.getSelection().empty();
			} else if (window.getSelection().removeAllRanges) {
				window.getSelection().removeAllRanges();
			}
		} else if (document.selection) {
			document.selection.empty();
		}
	};

	useEffect(() => {
		setBankSms(smsJson);
		var elem = document.getElementById("text");
		addEventListeners();

		document.addEventListener(
			"mouseup",
			function () {
				if (window.getSelection) {
					var text = window.getSelection().toString();
					var range = window.getSelection().getRangeAt(0);
					setStartOffset(range.startOffset);
					setEndOffset(range.endOffset);
				}
			},
			false
		);
	}, [cursor, bankSmsCount, documentList, nlpDocument]);

	const getUpdatedDocument = (start, end, text, feature, nlpDoc) => {
		var document = nlpDoc;
		document.text_snippet = { content: text };
		document.annotations = nlpDoc.annotations || [];
		var annotation = {};
		annotation.text_extraction = {};
		annotation.text_extraction.text_segment = {};
		annotation.text_extraction.text_segment.start_offset = start;
		annotation.text_extraction.text_segment.end_offset = end;
		annotation.display_name = feature;
		document.annotations.push(annotation);
		return document;
	};

	const updateLocalStorage = () => {
		localStorage.setItem("documentList", documentList);
	};

	return (
		<div id="body">
			<Head>
				<title>NLP Dataset Creator</title>
				<meta name="description" content="Generated by NLP Dataset Creator" />
				<link rel="icon" href="/favicon.ico" />
			</Head>

			<main className="flex flex-col justify-between items-center h-screen">
				<h1 className="text-5xl font-bold p-10">NLP Dataset Creator</h1>
				<h2 className="text-center font-medium text-2xl" id="text">
					{bankSms[bankSmsCount]}
				</h2>
				<div className="flex justify-center">
					Start Offset: {startOffset} | End Offset: {endOffset}
				</div>
				<div className="flex justify-between w-9/12 pb-10">
					<div
						className={
							"flex items-center px-8 py-4 rounded-xl bg-green-500 shadow-md " +
							(cursor === 0 && "border-t-4 border-black")
						}
					>
						Money
					</div>
					<div
						className={
							"flex items-center px-8 py-4 rounded-xl bg-yellow-700 shadow-md " +
							(cursor === 1 && "border-t-4 border-black")
						}
					>
						Transaction Type
					</div>
					<div
						className={
							"flex items-center px-8 py-4 rounded-xl bg-red-500 shadow-md " +
							(cursor === 2 && "border-t-4 border-black")
						}
					>
						A/c number
					</div>
					<div
						className={
							"flex items-center px-8 py-4 rounded-xl bg-blue-500 shadow-md " +
							(cursor === 3 && "border-t-4 border-black")
						}
					>
						Date
					</div>
					<div
						className={
							"flex items-center px-8 py-4 rounded-xl bg-yellow-500 shadow-md " +
							(cursor === 4 && "border-t-4 border-black")
						}
					>
						Payer
					</div>
					<div
						className={
							"flex items-center px-8 py-4 rounded-xl bg-purple-500 shadow-md " +
							(cursor === 5 && "border-t-4 border-black")
						}
					>
						Available Bal
					</div>
				</div>
			</main>
		</div>
	);
}
